<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <title>Logo Screensaver (OCaml demo friendly)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            background: #000;
            color: #ddd;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
        }

        #ui {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 16px;
            background: rgba(20, 20, 20, .7);
            border: 1px solid rgba(255, 255, 255, .15);
            border-radius: 10px;
            padding: 10px 12px;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 10;
            backdrop-filter: blur(6px);
        }

        #ui input[type="file"] {
            color: #ddd;
        }

        #ui label {
            font-size: 14px;
            opacity: .9;
        }

        #ui input[type="range"] {
            width: 120px;
        }

        #ui button {
            background: #1e88e5;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        #ui button.secondary {
            background: #444;
        }

        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        /* masque le curseur en mode “écran de veille” */
        .no-cursor {
            cursor: none;
        }
    </style>
</head>

<body>
    <canvas id="canvas"></canvas>

    <div id="ui">
        <label>
            Logo&nbsp;:
            <input id="file" type="file" accept="image/*" />
        </label>
        <label>Vitesse
            <input id="speed" type="range" min="10" max="600" value="220" />
        </label>
        <label>Taille
            <input id="size" type="range" min="6" max="40" value="20" />
        </label>
        <button id="start"> </button>
    </div>

    <script>
        // --- Canvas & contexte ---
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            const dpr = Math.max(1, window.devicePixelRatio || 1);
            canvas.width = Math.floor(innerWidth * dpr);
            canvas.height = Math.floor(innerHeight * dpr);
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }
        window.addEventListener('resize', () => {
            resizeCanvas();
            clampInside();
        });
        resizeCanvas();

        // --- Logo par défaut
        const logoImg = new Image();
        logoImg.src = "win.png";

        // --- État du "screensaver" ---
        let running = false;
        let rafId = null;

        const state = {
            x: 80,
            y: 60,
            w: 200,
            h: 200,
            vx: 220, //px/s ( vitesse )
            vy: 180, //px/s
            scalePct: 0.20, // taille
            lastT: performance.now(),
        };


        function updateLogoSize() {
            const minSide = Math.min(innerWidth, innerHeight);
            const target = Math.max(32, Math.round(minSide * (state.scalePct)));

            //img ratio
            const ratio = (logoImg.naturalWidth || 256) / (logoImg.naturalHeight || 256);
            if (ratio >= 1) {
                state.w = target;
                state.h = Math.round(target / ratio);
            } else {
                state.h = target;
                state.w = Math.round(target * ratio);
            }
        }

        function clampInside() {
            // Évite de sortir de l’écran quand resize
            state.x = Math.min(Math.max(0, state.x), innerWidth - state.w);
            state.y = Math.min(Math.max(0, state.y), innerHeight - state.h);
        }

        // --- Contrôles UI ---
        const fileInput = document.getElementById('file');
        const speedInput = document.getElementById('speed');
        const sizeInput = document.getElementById('size');
        const startBtn = document.getElementById('start');
        const stopBtn = document.getElementById('stop');
        const ui = document.getElementById('ui');

        fileInput.addEventListener('change', (e) => {
            const f = e.target.files && e.target.files[0];
            if (!f) return;
            const reader = new FileReader();
            reader.onload = () => {
                logoImg.onload = () => {
                    updateLogoSize();
                    clampInside();
                };
                logoImg.src = reader.result;
            };
            reader.readAsDataURL(f);
        });

        speedInput.addEventListener('input', () => {
            // 10..600 -> 50..1200 px/s
            const val = Number(speedInput.value);
            const speed = 2 * val;
            const angle = Math.atan2(state.vy, state.vx) || Math.PI / 4;
            state.vx = Math.cos(angle) * speed;
            state.vy = Math.sin(angle) * speed;
        });

        sizeInput.addEventListener('input', () => {
            // 6..40 -> 6%..40% du min(screenW, screenH)
            state.scalePct = Number(sizeInput.value) / 100;
            updateLogoSize();
            clampInside();
        });



        startBtn.addEventListener('click', async () => {
            if (!running) {
                start();
            } else {
                pause();
            }
        });



        // --- Animation ---
        function start() {
            running = true;
            state.lastT = performance.now();
            rafId = requestAnimationFrame(tick);
            startBtn.innerHTML = "pause";
        }

        function pause() {
            running = false;
            startBtn.innerHTML = "play"
        }

        function tick(t) {
            const dt = Math.min(0.05, (t - state.lastT) / 1000); // clamp 50ms
            state.lastT = t;
            update(dt);
            draw();
            if (running) rafId = requestAnimationFrame(tick);
        }

        function update(dt) {
            state.x += state.vx * dt;
            state.y += state.vy * dt;

            let bounced = false;
            if (state.x <= 0) {
                state.x = 0;
                state.vx = Math.abs(state.vx);
                bounced = true;
            } else if (state.x + state.w >= innerWidth) {
                state.x = innerWidth - state.w;
                state.vx = -Math.abs(state.vx);
                bounced = true;
            }
            if (state.y <= 0) {
                state.y = 0; state.vy = Math.abs(state.vy);
                bounced = true;
            } else if (state.y + state.h >= innerHeight) {
                state.y = innerHeight - state.h;
                state.vy = -Math.abs(state.vy);
                bounced = true;
            }

            if (bounced) {
                state.tintHue = (state.tintHue + 53) % 360;
            }
        }

        function draw() {
            ctx.drawImage(logoImg, state.x, state.y, state.w, state.h);


            ctx.save();
            ctx.globalAlpha = 0.12;
            ctx.globalCompositeOperation = 'color';
            ctx.fillStyle = `hsl(${state.tintHue} 90% 60%)`;
            ctx.fillRect(state.x, state.y, state.w, state.h);
            ctx.restore();
        }

        logoImg.onload = () => {
            updateLogoSize();
            speedInput.dispatchEvent(new Event('input'));

            state.x = Math.random() * (innerWidth - state.w);
            state.y = Math.random() * (innerHeight - state.h);
            draw();
            start();
        };
    </script>
</body>

</html>